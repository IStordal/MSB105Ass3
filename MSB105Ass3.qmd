---
title: "Assignment 3"
subtitle:  "Pendling"
author: "Ivan Stordal & Irjan Vikre"
date: last-modified
date-format: "dddd D MMM, YYYY"
csl: hvl_apa7_stil_bokmal_v1
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
---

```{r}
library(tidyverse) |> suppressPackageStartupMessages()
library(lubridate) |> suppressPackageStartupMessages()
library(PxWebApiData) |> suppressPackageStartupMessages()
library(flextable) |> suppressPackageStartupMessages()
library(dplyr) |> suppressPackageStartupMessages()
library(stringr) |> suppressPackageStartupMessages()
```

```{r}

Sys.setlocale("LC_ALL", "Norwegian")
```

# Kommuner og data innhenting fra SSB

```{r}
knr <- as.character(
  c(
    1102, 1103, 1108, 1124, 1127, 1120, 1122, 1121, 1119, 
    1144, 1130, 1106, 1146, 1149, 1216, 4612, 1145, 1133,
    1134, 1135, 1154, 1160, 1211, 4611, 1129, 1141, 1142
    )
  )
```

```{r}
knavn <- c("Sandnes (-2019)", "Stavanger", "Nye-Sandnes", 
           "Sola", "Randaberg", "Klepp", "Gjesdal", "Time", 
           "Hå", "Kvitsøy", "Strand", "Haugesund", "Tysvær", 
           "Karmøy", "Sveio (-2019)", "Sveio", "Bokn", 
           "Hjelmeland", "Suldal", "Sauda", "Vindafjord (-2006)", 
           "Vindafjord", "Etne (-2019)", "Etne", 
           "Forsand (-2019)", "Finnøy (-2020)",
           "Rennesøy (-2020)"
)
```

```{r}
#Get more info about table
ApiData(
"http://data.ssb.no/api/v0/en/table/03321",
returnApiQuery = TRUE
) 
```

```{r}
pend_02_24_ssb_boBF <- ApiData12(
    urlToData = "03321",
    ArbstedKomm = list('*'),
    Bokommuen = knr, # Merk skrivemåten
    Tid = as.character(2002:2024)
)
```

```{r}
#| cache: true

pend_02_24_boBF <- pend_02_24_ssb_boBF %>% 
  # Henter kommune navn fra desc df
  mutate(
    akom_navn = arbeidsstedskommune,
    bkom_navn = bostedskommune ,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = ""),
    # skifter navn og nummer for Etne og Sveio
    akom = ifelse(akom == "k1211", "k4611", akom),
    akom = ifelse(akom == "k1216", "k4612", akom),
    bkom = ifelse(bkom == "k1211", "k4611", bkom),
    bkom = ifelse(bkom == "k1216", "k4612", bkom),
    akom_navn = ifelse(akom_navn == "Etne (-2019)", "Etne", akom_navn),
    akom_navn = ifelse(akom_navn == "Sveio (-2019)", "Sveio", akom_navn),
    bkom_navn = ifelse(bkom_navn == "Etne (-2019)", "Etne", bkom_navn),
    bkom_navn = ifelse(bkom_navn == "Sveio (-2019)", "Sveio", bkom_navn)    
  ) %>% 
  # Endrer noen variabelnavn
  rename(
    aar = Tid,
    pendlere = value 
  )  %>%
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>% 
  as_tibble()
```

```{r}
print(pend_02_24_boBF, n = 5)
```

```{r}
pend_02_24_ssb_arbBF <- ApiData12(
    urlToData   = "03321",
    ArbstedKomm = knr,               # jobber i Bokna-kommunene
    Bokommuen   = list('*'),         # bor i alle kommuner
    Tid         = as.character(2002:2024)
)

```

```{r}
#| cache: true

pend_02_24_arbBF <- pend_02_24_ssb_arbBF %>% 
  # Henter kommune navn fra desc df
  mutate(
    akom_navn = arbeidsstedskommune,
    bkom_navn = bostedskommune ,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = ""),
    # skifter navn og nummer for Etne og Sveio
    akom = ifelse(akom == "k1211", "k4611", akom),
    akom = ifelse(akom == "k1216", "k4612", akom),
    bkom = ifelse(bkom == "k1211", "k4611", bkom),
    bkom = ifelse(bkom == "k1216", "k4612", bkom),
    akom_navn = ifelse(akom_navn == "Etne (-2019)", "Etne", akom_navn),
    akom_navn = ifelse(akom_navn == "Sveio (-2019)", "Sveio", akom_navn),
    bkom_navn = ifelse(bkom_navn == "Etne (-2019)", "Etne", bkom_navn),
    bkom_navn = ifelse(bkom_navn == "Sveio (-2019)", "Sveio", bkom_navn)    
  ) %>% 
  # Endrer noen variabelnavn
  rename(
    aar = Tid,
    pendlere = value 
  )  %>%
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>% 
  as_tibble()
```

```{r}
print(pend_02_24_arbBF, n = 5)
```

## Kommunesammenslåingene

```{r}
# knr Bokn-regionen utenom kommunene som inngår i Nye Stavanger,
# Nye Sandnes og Vindafjord
knr_u_SSV <- paste(
  "k", 
  c(
    1124, 1127, 1120, 1122, 1121, 1119, 1144, 1130, 1106, 1146, 1149, 1145, 1133, 1134, 1135,  1102, 4611, 4612
    ),
  sep = ""
)
```

### Bosted rundt Boknafjorden

```{r}
pend_02_24_boBF <- pend_02_24_boBF %>% 
  mutate(
    nye_bkom = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      bkom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-region beholder sin bkom
      TRUE ~ bkom
    ),
    nye_bkom_navn = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      bkom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige  Bokna-region beholder sitt bkom_navn
      TRUE ~ bkom_navn
    ),
    nye_akom = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      akom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-regionen beholder sin akom
      akom %in% knr_u_SSV ~ akom,   
      # Resten av landet kodes som knr "9999"
      TRUE ~ "k9999"
    ),
    nye_akom_navn = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      akom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige Bokna-regionen beholder sitt akom_navn
      akom %in% knr_u_SSV ~ akom_navn,  
      # Resten av landet kodes som knr "RAL"
      TRUE ~ "RAL"
      )
  )
```

```{r}
pend_02_24_boBF_agg <- pend_02_24_boBF %>% 
  group_by(
    aar, 
    nye_akom, nye_akom_navn,
    nye_bkom, nye_bkom_navn
  ) %>% 
  summarise(
    pendlere = sum(pendlere, na.rm = TRUE),
    .groups = "drop"
  )

print(pend_02_24_boBF_agg, n = 5)

```

### Eksempel: Stavanger

```{r}
pend_02_24_boBF_agg %>% 
  filter(nye_akom == "k1103", nye_bkom == "k1103") %>% 
  arrange(aar) %>% 
  print(n = 25)
```

```{r}
pend_02_24_boBF_agg %>% 
  distinct(nye_bkom) %>% 
  pull(nye_bkom) %>% 
  print(width = 70)

```

```{r}
pend_02_24_boBF_agg %>% 
  distinct(nye_akom) %>% 
  pull(nye_akom) %>% 
  print(width = 70)

```

### Tilsvarende for pend_02_24_arbBF

```{r}
pend_02_24_arbBF <- pend_02_24_arbBF %>% 
  mutate(
# Nye bostedskommuner
    nye_bkom = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      bkom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      bkom %in% knr_u_SSV ~ bkom,
      # Resten av landet → RAL
      TRUE ~ "k9999"
    ),
    nye_bkom_navn = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      bkom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      bkom %in% knr_u_SSV ~ bkom_navn,
      TRUE ~ "RAL"
    ),

    # Nye arbeidsstedskommuner
    nye_akom = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      akom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      akom %in% knr_u_SSV ~ akom,
      TRUE ~ akom
    ),
    nye_akom_navn = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      akom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      akom %in% knr_u_SSV ~ akom_navn,
      TRUE ~ akom_navn
    )
  )
```

```{r}
pend_02_24_arbBF_agg <- pend_02_24_arbBF %>% 
  group_by(
    aar,
    nye_akom, nye_akom_navn,
    nye_bkom, nye_bkom_navn
  ) %>% 
  summarise(
    pendlere = sum(pendlere, na.rm = TRUE),
    .groups = "drop"
  )

```

```{r}
pend_02_24_arbBF_agg %>% 
  filter(nye_akom == "k1103", nye_bkom == "k1103") %>% 
  arrange(aar) %>% 
  print(n = 25)

```

```{r}
pend_02_24_arbBF_agg %>% 
  distinct(nye_bkom) %>% 
  pull(nye_bkom) %>% 
  print(width = 70)

```

```{r}
pend_02_24_arbBF_agg %>% 
  distinct(nye_akom) %>% 
  pull(nye_akom) %>% 
  print(width = 70)

```

```{r}
pend_02_24_arbBF_agg <- pend_02_24_arbBF_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn
  )
```

```{r}
pend_02_24_boBF_agg <- pend_02_24_boBF_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn
  )
```

```{r}
names(pend_02_24_arbBF_agg)
```

```{r}
names(pend_02_24_boBF_agg)
```

```{r}
boBF_arb_RAL <- pend_02_24_boBF_agg |>
  filter(akom == "k9999")
```

```{r}
pend_02_24 <- bind_rows(
  pend_02_24_arbBF_agg,
  boBF_arb_RAL
  )
```

```{r}
names(pend_02_24)
```

```{r}
dim(pend_02_24)
```

```{r}
names(pend_02_24_arbBF_agg)
```

```{r}
dim(pend_02_24_arbBF_agg)
```

```{r}
names(pend_02_24_boBF_agg)
```

```{r}
dim(pend_02_24_boBF_agg)
```

```{r}
# Rydder ved å fjerne det vi ikke trenger
rm(boBF_arb_RAL, pend_02_24_arbBF, pend_02_24_boBF, 
   pend_02_24_ssb_arbBF, pend_02_24_ssb_boBF
   )
```

## Totalt antall arbeidstakere i hele landet per år

```{r}
# oppdatert med "31", "32", "33", "39", "40", "55", "56"
# for splitting i 2024
fnr <- c(
  "30", "01", "02", "06", "03", "34", "04", "05", "38",
  "07", "08", "42", "09", "10", "11", "46", "12", "14",
  "15", "50", "16", "17", "18", "54", "19", "20", "31", 
  "32", "33", "39", "40", "55", "56"
  )
```

```{r}
tot_arb_HL_raw <- ApiData12(
  urlToData = "11616",
  Region    = fnr,
  Tid       = as.character(2002:2024)
)

```

```{r}
tot_arb_HL <- tot_arb_HL_raw %>% 
  # 1. Kun bosatt i regionen
  filter(statistikkvariabel == "Sysselsatte personer bosatt i regionen") %>% 
  # 2. Kun alder 15–74
  filter(str_detect(Alder, "15-74")) %>% 
  # 3. Summerer over alle fylker og kjønn per år
  group_by(Tid) %>% 
  summarise(
    arbtak_HL = sum(value, na.rm = TRUE),
    .groups   = "drop"
  ) %>% 
  rename(aar = Tid) %>% 
  arrange(aar) %>% 
  as_tibble()

print(tot_arb_HL, n = 23)
```

## Beregning av bo og jobbfordeling mellom Bokna-regionen og resten av landet

```{r}
# Boknafjordkommuner etter sammenslåinger
bf_kommuner <- c(
  "k1108",  # Sandnes
  "k1103",  # Stavanger
  "k1160",  # Vindafjord
  "k1124", "k1127", "k1120", "k1122", "k1121", "k1119",
  "k1144", "k1130", "k1106", "k1146", "k1149", "k1145",
  "k1133", "k1134", "k1135"
)
```

```{r}
# Bor i BF og jobber i BF

bBFjBF <- pend_02_24 %>% 
  filter(bkom %in% bf_kommuner,
         akom %in% bf_kommuner) %>% 
  group_by(aar) %>% 
  summarise(bBFjBF = sum(pendlere), .groups = "drop")
```

```{r}
# Bor i Boknafjorden og jobber i resten av landet

bBFjRAL <- pend_02_24 %>% 
  filter(bkom %in% bf_kommuner,
         akom == "k9999") %>% 
  group_by(aar) %>% 
  summarise(bBFjRAL = sum(pendlere), .groups = "drop")
```

```{r}
#Bir i resten av landet og jobber i Boknafjorden 

bRALjBF <- pend_02_24 %>% 
  filter(!(bkom %in% bf_kommuner),
         bkom != "k9999",
         akom %in% bf_kommuner) %>% 
  group_by(aar) %>% 
  summarise(bRALjBF = sum(pendlere), .groups = "drop")
```

```{r}
#Kombinerer bo og jobbfordeling til et datasett over arbeidsflyt


arb_flyt_02_24 <- tot_arb_HL %>% 
  left_join(bBFjBF,  by = "aar") %>%
  left_join(bBFjRAL, by = "aar") %>%
  left_join(bRALjBF, by = "aar") %>% 
  mutate(
    bBFjBF  = replace_na(bBFjBF, 0),
    bBFjRAL = replace_na(bBFjRAL, 0),
    bRALjBF = replace_na(bRALjBF, 0)
  )

```

```{r}
print(arb_flyt_02_24, n = 23)
```

```{r}
# Fjerne koder for resten av landet
pend_clean <- pend_02_24 %>% 
  filter(akom != "k9999")   
```

```{r}
# Pivotering hvor bosted settes som rader og arbeidsted settes som kolonner 

pend_mat <- pend_clean %>%
  select(aar, bkom, akom, pendlere) %>%
  pivot_wider(
    names_from = akom,
    values_from = pendlere,
    values_fill = 0
  )
```

```{r}
# Totalt bosatte arbeidstakere i Boknafjorden 

pend_mat <- pend_mat %>%
  mutate(k0000_TotalBo = rowSums(across(starts_with("k"))))
```

```{r}
#Beregner prosentvis andel av bosatte

andel_pend_mat <- pend_mat %>%
  mutate(across(
    starts_with("k"),
    ~ ifelse(k0000_TotalBo > 0, .x / k0000_TotalBo * 100, 0),
    .names = "andel_{.col}"
  ))
```

```{r}
#Omgjør oversikten over andel bosatte til langt format

andel_pendle_data_02_24_long <- andel_pend_mat %>%
  select(aar, bkom, starts_with("andel_")) %>%
  pivot_longer(
    cols = starts_with("andel_"),
    names_to = "akom",
    names_prefix = "andel_",
    values_to = "andel"
  ) %>%
  arrange(aar, bkom, akom)
```

## Analysering av pendlerdata

```{r}
#Lager en tabell som kan brukes for å finne fordelingen av pendler kommuner for en bo-kommune for et år

tab_pendlere <- function(data, bosted, aar, top_n = 10) {
  
  data %>%
    filter(bkom == bosted, aar == !!aar) %>%
    arrange(desc(andel)) %>%
    slice_head(n = top_n) %>%
    mutate(
      akom = str_remove(akom, "^k"),
      andel = round(andel, 1)
    ) %>%
    flextable() %>%
    autofit()
}
```

```{r}
tab_pendlere(andel_pendle_data_02_24_long, "k1103", 2023)
```

```{r}
# Setter opp oversikten for tabellen over i stolpediagram 

plot_pendlere <- function(data, bosted, aar, top_n = 12) {
  
  df <- data %>%
    filter(bkom == bosted, aar == !!aar) %>%
    arrange(desc(andel)) %>%
    slice_head(n = top_n) %>%
    mutate(
      akom = str_remove(akom, "^k"),
      akom = factor(akom, levels = akom)
    )
  
  ggplot(df, aes(x = akom, y = andel)) +
    geom_col(fill = "steelblue") +
    labs(
      title = paste0("Pendling fra kommune ", bosted, " i ", aar),
      x = "Arbeidsstedskommune",
      y = "Andel pendlere (%)"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 50, hjust = 1))
}
```

```{r}
plot_pendlere(andel_pendle_data_02_24_long, "k1103", 2024)
```

```{r}
pend_mat <- function(data, aar) {
  
  data %>%
    filter(aar == !!aar) %>%
    select(bkom, akom, pendlere) %>%
    pivot_wider(
      names_from = akom,
      values_from = pendlere,
      values_fill = 0
    ) %>%
    arrange(bkom)
}
```

```{r}
pend_mat_2024 <- pend_mat(pend_02_24, 2024)
pend_mat_2010 <- pend_mat(pend_02_24, 2010)
```

```{r}
andel_pendle_data_02_24_long <- andel_pendle_data_02_24_long %>%
  mutate(
    bkom = str_trim(bkom),
    akom = str_trim(akom),
    bkom = ifelse(!str_starts(bkom, "k"), paste0("k", bkom), bkom),
    akom = ifelse(!str_starts(akom, "k"), paste0("k", akom), akom)
  )
  

```

```{r}
# Intern pendling i alle kommuner fordelt på år

intern_pendling <- andel_pendle_data_02_24_long %>%
  filter(bkom == akom) %>%
  arrange(bkom, aar)
```

```{r}
intern_pendling %>% group_by(bkom) %>% summarise(n_rows = n())
```

```{r}
# Muterer aar til numerisk for å unngå feilmeldinger i GGplot
intern_pendling <- intern_pendling %>%
  mutate(aar = as.numeric(aar))
```

```{r}
#Visualisering av prosentandell som jobber i hjemme kommune

ggplot(intern_pendling,
       aes(x = aar, y = andel, color = bkom, group = bkom)) +
  geom_line(linewidth = 1.1) +
  scale_x_continuous(breaks = seq(2002, 2024, by = 2)) +
  labs(
    title = "Intern pendling (bor og jobber i samme kommune)",
    x = "År",
    y = "Andel (%)",
    color = "Kommune"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
# For å få et plot som er enklere å tyde lages et diagram med bare de "store" kommunene
store_kommuner <- c("k1103", "k1108", "k1124", "k1106", "k1149") 
# Stavanger, Sandnes, Sola, Haugesund, Karmøy

plot_intern_store <- intern_pendling %>%
  filter(bkom %in% store_kommuner) %>%
  ggplot(aes(x = aar, y = andel, color = bkom)) +
  geom_line(linewidth = 1.2) +
  labs(
    title = "Intern pendling i store kommuner i Bokna-regionen",
    x = "År",
    y = "Andel (%)",
    color = "Kommune"
  ) +
  theme_minimal()

plot_intern_store
```

## Pendlingsanalyse for utvalgte kommuner

Videre kommer diagram som viser fordelingen av pendlere for fem av de største kommunene.
Diagrammene gir en oversikt over hvor stor andel av bokommunen bendler til hver enkelt arbeidskommune

```{r}
#Plot pendling Stavanger regionen 2024
plot_pendlere(andel_pendle_data_02_24_long, "k1103", 2024)
```

```{r}
#Plot pendling Sandnes regionen 2024

plot_pendlere(andel_pendle_data_02_24_long, "k1108", 2024)
```

```{r}
#Plot pendling Sola regionen 2024

plot_pendlere(andel_pendle_data_02_24_long, "k1124", 2024)
```

```{r}
#Plot pendling Haugesund regionen 2024

plot_pendlere(andel_pendle_data_02_24_long, "k1106", 2024)
```

```{r}
#Plot pendling Karmøy regionen 2024

plot_pendlere(andel_pendle_data_02_24_long, "k1149", 2024)
```

Videre lages matriser for pendlerdataene.
Det vil blli benyttet utvalgte år fra årrekken, for å holde det overkommelig.

```{r}
pend_mat_2002 <- pend_mat(pend_02_24, 2002)
pend_mat_2005 <- pend_mat(pend_02_24, 2005)
pend_mat_2010 <- pend_mat(pend_02_24, 2010)
pend_mat_2015 <- pend_mat(pend_02_24, 2015)
pend_mat_2023 <- pend_mat(pend_02_24, 2023)
pend_mat_2024 <- pend_mat(pend_02_24, 2024)
```

```{r}
vis_pend_mat <- function(data, aar) {
  df <- pend_mat(data, aar)
  flextable(df)
}

vis_pend_mat(pend_02_24, 2002)
```

```{r}
# Heatmap pendler oversikt 
heatmap_pend <- function(data, aar) {
  df <- pend_mat(data, aar) %>%
    pivot_longer(
      cols = -bkom,
      names_to = "akom",
      values_to = "pendlere"
    )
  
  ggplot(df, aes(x = akom, y = bkom, fill = pendlere)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "steelblue") +
    labs(title = paste("Pendlematrise", aar),
         x = "Arbeidssted",
         y = "Bosted") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

heatmap_pend(pend_02_24, 2024)
```
